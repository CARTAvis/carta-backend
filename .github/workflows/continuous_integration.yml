name: ci
on: push
jobs:
  format-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: ./scripts/style.py all check

  macOS-12-backend-build:
    runs-on: [self-hosted, macOS-12-M1]
    steps:
      - name: Build carta-backend      
        uses: actions/checkout@v3
        shell: bash
        run: |
          git submodule update --init --recursive
          mkdir build && cd build
          cmake .. -Dtest=on -DDevSuppressExternalWarnings=ON -DCMAKE_BUILD_TYPE=Debug -DCMAKE_CXX_FLAGS='-O0 -g -fsanitize=address -fno-omit-frame-pointer' -DCMAKE_EXE_LINKER_FLAGS='-fsanitize=address'
          make -j 8
          ./carta_backend --version
          
      - name: Save unit tests directory
        uses: actions/upload-artifact@v3
        with:
          name: macos12-unit-tests
          path: build/test

  macOS-12-unit-tests:
    runs-on: [self-hosted, macOS-12-M1]
    needs: backend-build-macOS-12
    steps:
      - name: Restore unit tests directory      
        uses: actions/download-artifact@v3      
        with:
          name: macos12-unit-tests
      - name: Run unit tests
        shell: bash
        run: |
          cd build/test
          ASAN_OPTIONS=suppressions=${WORKSPACE}/debug/asan/myasan.supp:detect_container_overflow=0 ASAN_SYMBOLIZER_PATH=/opt/homebrew/opt/llvm/bin/llvm-symbolizer ./carta_backend_tests --gtest_output=xml:macos_test_detail.xml"
