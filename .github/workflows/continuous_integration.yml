name: ci
on: push
jobs:
  format-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: ./scripts/style.py all check

  macOS-12:
    runs-on: [self-hosted, macOS-12-M1]
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Build backend  
        shell: bash
        run: |
          git submodule update --init --recursive
          mkdir build && cd build
          cmake .. -Dtest=on -DDevSuppressExternalWarnings=ON -DCMAKE_BUILD_TYPE=Debug -DCMAKE_CXX_FLAGS='-O0 -g -fsanitize=address -fno-omit-frame-pointer' -DCMAKE_EXE_LINKER_FLAGS='-fsanitize=address'
          make -j 8
          ./carta_backend --version

      - name: Run unit tests
        shell: bash
        run: |
          cd build/test
          ASAN_OPTIONS=suppressions=$GITHUB_WORKSPACE/debug/asan/myasan.supp:detect_container_overflow=0 ASAN_SYMBOLIZER_PATH=/opt/homebrew/opt/llvm/bin/llvm-symbolizer ./carta_backend_tests --gtest_output=xml:macos_test_detail.xml

      - name: Unit test report
        uses: dorny/test-reporter@v1
        if: success() || failure()
        with:
          name: macOS unit tests
          path: build/test/macos_test_detail.xml
          reporter: java-junit

